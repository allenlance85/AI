import openai
import tkinter as tk
import json

def generate_response(prompt, chat_history, model, temperature=0.5, max_tokens=100):
    # Format the chat history as a single string
    chat_history_str = "\n".join(chat_history)

    # Create the prompt for the AI
    prompt_str = f"{prompt}\n{chat_history_str}\nUser:"

    # Generate the AI's response
    response = openai.Completion.create(
        engine=model,
        prompt=prompt_str,
        temperature=temperature,
        max_tokens=max_tokens,
        n=1,
        stop=None,
        frequency_penalty=0,
        presence_penalty=0,
        api_key=openai.api_key
    )

    # Extract the first choice from the response and return it
    choice = response.choices[0].text
    return choice.strip()

def send_message(event=None):
    # Get the user's input
    user_input = user_input_box.get()
    
    # Clear the user input box
    user_input_box.delete(0, tk.END)
    
    # Add the user's input to the chat history
    chat_history.append(f"You: {user_input}")
    
    # Generate a response from the AI model
    response = None
    while response is None:
        response = generate_response(prompt, chat_history, model)
    
    # Add the AI's response to the chat history
    chat_history.append(f"AI: {response}")
    
    # Update the chat history box
    chat_history_box.configure(state="normal")
    chat_history_box.insert(tk.END, "\n".join(chat_history[-2:]) + "\n")
    chat_history_box.configure(state="disabled")
    
# Load API key from JSON file
with open('secrets.json') as f:
    secrets = json.load(f)
api_key = secrets['OPENAI_API_KEY']
openai.api_key = api_key

# Set up the AI model and prompt
model = "davinci"
prompt = "The following is a conversation with an AI assistant. The assistant is helpful, creative, clever, and very friendly. User:"

# Initialize the chat history
chat_history = []

# Create the GUI
root = tk.Tk()
root.title("Chatbot")

# Create the chat history box
chat_history_box = tk.Text(root, height=20, width=50)
chat_history_box.configure(state="disabled")
chat_history_box.pack()

# Create the user input box
user_input_box = tk.Entry(root, width=50)
user_input_box.bind("<Return>", send_message)
user_input_box.pack()

# Create the send button
send_button = tk.Button(root, text="Send", command=send_message)
send_button.pack()

# Start the GUI
root.mainloop()
